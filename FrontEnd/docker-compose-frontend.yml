services:
  # React 빌드 서비스
  nowdoboss_react_service:
    container_name: nowdoboss-react
    build:
      context: .
      dockerfile: React.Dockerfile
    image: nowdoboss-react-img
    volumes:
      - nowdoboss_react_build:/usr/src/app/dist  # 빌드된 React 정적 파일을 로컬 볼륨에 저장합니다.
    entrypoint: ["true"]  # 컨테이너가 빌드된 후 바로 종료되도록 설정합니다. 빌드만 수행하기 때문에 애플리케이션을 실행하지 않습니다.

  # Nginx WebServer 서비스
  nowdoboss_frontend_service:
    container_name: nowdoboss-frontend
    build:
      context: ../CICD/Nginx
      dockerfile: Nginx.Dockerfile
    image: nowdoboss-frontend-img
    restart: always
    volumes:
      - nowdoboss_react_build:/usr/share/nginx/html  # 빌드된 정적 파일을 Nginx가 서빙할 경로에 마운트합니다.
      - ./certbot/conf:/etc/letsencrypt  # Certbot이 사용하는 SSL 인증서 경로를 Nginx와 공유합니다.
      - ./certbot/www:/var/www/certbot  # Certbot 인증 파일을 저장할 경로를 Nginx와 공유합니다.
      - geoip_data:/usr/share/GeoIP  # GeoIP 데이터베이스를 공유합니다.
    ports:
      - "${NGINX_HTTP_PORT}:${NGINX_HTTP_PORT}"  # Nginx의 HTTP 트래픽을 포트
      - "${NGINX_HTTPS_PORT}:${NGINX_HTTPS_PORT}"  # Nginx의 HTTPS 트래픽을 포트
    networks:
      - nowdoboss-net  # 애플리케이션 서비스들이 같은 네트워크에 연결되도록 설정합니다.
    depends_on:
      - nowdoboss_react_service  # React 빌드가 완료된 후 Nginx가 실행되도록 의존성을 설정합니다.
      # - geoip_service  # GeoIP 데이터가 업데이트된 후 Nginx 실행되도록 의존성을 설정합니다.
    command: "/bin/sh -c 'nginx -g \"daemon off;\"'"  # Nginx를 포그라운드에서 실행하여 컨테이너가 종료되지 않도록 합니다.

  # Certbot SSL 관리 서비스
  nowdoboss_certbot_service:
    container_name: nowdoboss-certbot  # Certbot 컨테이너 이름을 설정합니다.
    image: certbot/certbot  # Let's Encrypt 인증서를 관리하기 위한 Certbot 이미지를 사용합니다.
    restart: always
    volumes:
      - ./certbot/conf:/etc/letsencrypt  # Certbot이 사용하는 SSL 인증서 경로입니다.
      - ./certbot/www:/var/www/certbot  # Certbot의 인증 경로를 설정합니다.
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --quiet --no-self-upgrade --deploy-hook \"docker exec nowdoboss-frontend nginx -s reload\"; sleep 12h & wait $${!}; done;'"  # Certbot이 인증서를 갱신한 후 Nginx를 자동으로 리로드합니다.
    depends_on:
      - nowdoboss_frontend_service  # Nginx가 실행된 후 Certbot이 동작하도록 의존성을 설정합니다.

  # GeoIP 서비스
  geoip_service:
    image: maxmindinc/geoipupdate:latest
    container_name: geoip
    restart: always
    environment:
      GEOIPUPDATE_ACCOUNT_ID: ${GEOIPUPDATE_ACCOUNT_ID}
      GEOIPUPDATE_LICENSE_KEY: ${GEOIPUPDATE_LICENSE_KEY}
      GEOIPUPDATE_EDITION_IDS: ${GEOIPUPDATE_EDITION_IDS}
      GEOIPUPDATE_FREQUENCY: ${GEOIPUPDATE_FREQUENCY}
    volumes:
      - geoip_data:/usr/share/GeoIP  # GeoIP 데이터베이스 공유

volumes:
  nowdoboss_react_build:  # React 빌드 결과를 저장할 공유 볼륨
  geoip_data: # GeoIP 데이터 베이스 공유 볼륨

networks:
  nowdoboss-net:
    name: nowdoboss-net
    driver: bridge
