# HTTP 서버 설정
# server {
#     listen 80;
#     server_name nowdoboss.com www.nowdoboss.com;

#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#         try_files $uri $uri/ =404;
#     }

#     # 프론트엔드 설정
#     location / {
#         root /usr/share/nginx/html;
#         index index.html;
#         try_files $uri $uri/ /index.html;
#     }

#     # 백엔드 프록시 설정
#     location /api {
#         proxy_pass http://nowdoboss-backend-springboot:8080;  
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

http {
    # GeoIP2 설정: MaxMind GeoLite2 데이터베이스를 사용하여 국가 정보를 확인합니다.
    geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
        auto_reload 6h;  # 6시간마다 데이터베이스를 다시 로드합니다.
        $geoip2_data_country_code country iso_code;
        $geoip2_data_country_name country names en;
    }

    # 특정 국가 허용 (한국과 미국만 허용)
    map $geoip2_data_country_code $allowed_country {
        default no;  # 기본적으로 모든 국가 차단
        KR yes;      # 한국 허용
        US yes;      # 미국 허용
    }

    # HTTP 리다이렉션을 HTTPS로
    server {
        listen 80;
        server_name nowdoboss.com www.nowdoboss.com;

        # Certbot 인증 경로는 리다이렉트하지 않도록 예외 처리
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
            try_files $uri $uri/ =404;
        }

        # 모든 HTTP 요청은 HTTPS로 리다이렉트
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS 서버 설정
    server {
        listen 443 ssl;
        server_name nowdoboss.com www.nowdoboss.com;

        ssl_certificate /etc/letsencrypt/live/www.nowdoboss.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/www.nowdoboss.com/privkey.pem;

        # 국가 차단: 한국, 미국 제외한 모든 국가 403 에러 반환
        if ($allowed_country = no) {
            return 403 "Access Forbidden";
        }

        # 프론트엔드 파일 제공
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        # 백엔드 API 프록시
        location /api {
            proxy_pass http://nowdoboss-backend-springboot:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # SSE 설정 추가
            location /api/v1/sse/subscribe {
                proxy_pass http://nowdoboss-backend-springboot:8080;
                proxy_http_version 1.1;
                proxy_set_header Connection '';
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;  # SSE 버퍼링 비활성화
            }
        }

        # 백엔드 웹소켓 프록시
        location /ws {
            proxy_pass http://nowdoboss-backend-springboot:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 로그 포맷에 국가 정보 추가
        log_format custom '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          '$geoip2_data_country_code $geoip2_data_country_name';

        access_log /var/log/nginx/access.log custom;
    }
}